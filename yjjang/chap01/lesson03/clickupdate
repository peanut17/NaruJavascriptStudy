
ClickHouseëŠ” ê¸°ë³¸ì ìœ¼ë¡œ Upsert(INSERT ... ON DUPLICATE KEY UPDATE) ê¸°ëŠ¥ì´ ì—†ê¸° ë•Œë¬¸ì—, UPDATE ë˜ëŠ” DELETE + INSERT ë°©ì‹ìœ¼ë¡œ í‚¤ ê¸°ì¤€ì˜ ë°ì´í„°ë¥¼ ê°±ì‹ í•´ì•¼ í•©ë‹ˆë‹¤. PySparkë¡œ ì²˜ë¦¬í•˜ê³  ìˆë‹¤ë©´, ì•„ë˜ì™€ ê°™ì´ ë‹¨ê³„ì ìœ¼ë¡œ ì„¤ê³„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.


---

âœ… 1. ê¸°ë³¸ ì „ì œ

Kafkaì—ì„œ CDC(Change Data Capture) ë°©ì‹ìœ¼ë¡œ op_codeë¥¼ ê¸°ì¤€ìœ¼ë¡œ I, U, D ì´ë²¤íŠ¸ë¥¼ ìˆ˜ì‹ 

ê° rowëŠ” before, after êµ¬ì¡°ì˜ JSON í˜•íƒœ

ê° í…Œì´ë¸”ë§ˆë‹¤ Primary Key ì—­í• ì„ í•˜ëŠ” ì»¬ëŸ¼ ëª©ë¡ì´ ì¡´ì¬ (ì˜ˆ: JSON íŒŒì¼ë¡œ ë§¤í•‘)



---

âœ… 2. Update (U) ì´ë²¤íŠ¸ ì²˜ë¦¬ ë°©ë²•

ğŸ”¹ 2-1. PySparkì—ì„œ 'U' ì´ë²¤íŠ¸ í•„í„°ë§

update_df = df.filter(col("op_code") == "U")

ğŸ”¹ 2-2. foreachPartitionìœ¼ë¡œ ë³‘ë ¬ ì²˜ë¦¬

update_df.foreachPartition(lambda partition: handle_update_partition(partition))

ğŸ”¹ 2-3. íŒŒí‹°ì…˜ ì²˜ë¦¬ í•¨ìˆ˜

def handle_update_partition(rows):
    from clickhouse_driver import Client
    client = Client(host="your_host", database="your_db", user="default", password="your_pw")
    
    for row in rows:
        row_dict = row.asDict()
        handle_update(row_dict, client)


---

âœ… 3. handle_update í•¨ìˆ˜

import json

def handle_update(row, client):
    before = row.get("before")
    after = row.get("after")
    table = row.get("table")  # ì˜ˆ: "user", "order"

    if not before or not after:
        print("[WARN] before/after ëˆ„ë½")
        return

    # ğŸ” í‚¤ ëª©ë¡ ë¡œë”© (í…Œì´ë¸”ë³„ í‚¤ ë§¤í•‘ JSON)
    with open("primary_keys.json") as f:
        pk_map = json.load(f)

    primary_keys = pk_map.get(table)
    if not primary_keys:
        print(f"[ERROR] í…Œì´ë¸” {table}ì˜ PK ì •ë³´ ì—†ìŒ")
        return

    # ğŸ”„ ë³€ê²½ëœ ì»¬ëŸ¼ë§Œ SET êµ¬ì„±
    set_clause = []
    for col in after:
        if before.get(col) != after.get(col):
            set_clause.append(f"{col} = {format_value(after[col])}")
    
    if not set_clause:
        return  # ë³€ê²½ ì—†ìŒ

    # ğŸ”‘ WHERE ì¡°ê±´ êµ¬ì„±
    where_clause = " AND ".join([f"{key} = {format_value(before[key])}" for key in primary_keys])

    # ğŸ“¤ SQL ì‹¤í–‰
    sql = f"ALTER TABLE {table} UPDATE {', '.join(set_clause)} WHERE {where_clause}"
    client.execute(sql)

ğŸ”¹ format_value í•¨ìˆ˜

ClickHouseìš© SQLì— ë§ê²Œ ê°’ í¬ë§·

def format_value(val):
    if isinstance(val, str):
        return f"'{val}'"
    elif val is None:
        return 'NULL'
    else:
        return str(val)


---

âœ… 4. ë³´ì™„ í¬ì¸íŠ¸

ì„±ëŠ¥ ìµœì í™”: UPDATEëŠ” ClickHouseì—ì„œ ëŠë¦´ ìˆ˜ ìˆìŒ â†’ ë°°ì¹˜ ì—…ë°ì´íŠ¸/TTL/ë©€í‹° íŒŒí‹°ì…˜ ì „ëµ ê³ ë ¤

íŠ¸ëœì­ì…˜ ë¯¸ì§€ì›: ì—¬ëŸ¬ ê±´ì„ ë™ì‹œì— ë³€ê²½í•˜ë‹¤ ì¤‘ê°„ ì‹¤íŒ¨ ì‹œ ë¡¤ë°± ì—†ìŒ â†’ idempotent ì„¤ê³„ ì¤‘ìš”

íŒŒí‹°ì…˜ ì»¬ëŸ¼ í¬í•¨ ì—¬ë¶€: UPDATE ëŒ€ìƒ ì»¬ëŸ¼ì´ íŒŒí‹°ì…˜ í‚¤ í¬í•¨ ì—¬ë¶€ì— ë”°ë¼ ì„±ëŠ¥ì´ í¬ê²Œ ë‹¬ë¼ì§



---

âœ… ì°¸ê³ : JSON í‚¤ ë§¤í•‘ ì˜ˆì‹œ (primary_keys.json)

{
  "user": ["id"],
  "order": ["order_id", "site_cd"]
}


---

ì›í•˜ì‹œê±°ë‚˜ ê³ ë ¤ ì¤‘ì´ì‹  ë¶€ë¶„

merge_tree or replacing_merge_tree ì‚¬ìš©ì— ë”°ë¼ ì „ëµ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆìŒ

DELETE + INSERT ë°©ì‹ìœ¼ë¡œ êµ¬í˜„ ì›í•˜ì‹œë©´ ì˜ˆì‹œë„ ë“œë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤

íŒŒí‹°ì…˜ ëŒ€ìƒì¸ ê²½ìš°ëŠ” ALTER TABLE ... UPDATEê°€ ë¶ˆê°€í•œ ê²½ìš°ë„ ìˆìŠµë‹ˆë‹¤


í•„ìš”í•˜ì‹  ë°©ì‹(ì˜ˆ: UPDATE vs DELETE+INSERT)ì´ë‚˜ êµ¬ì¡°ì  ì œì•½ì‚¬í•­ì´ ìˆë‹¤ë©´ ì¶”ê°€ë¡œ ì•Œë ¤ì£¼ì„¸ìš”.

