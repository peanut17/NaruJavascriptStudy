
ì¢‹ìŠµë‹ˆë‹¤! Kafkaì—ì„œ op_code = Uì¼ ë•Œ:

before: ê¸°ì¡´ ê°’ â†’ WHERE ì ˆì˜ ê¸°ì¤€ (ì¦‰, PK ê°’)

after: ë³€ê²½ëœ ê°’ë§Œ í¬í•¨ â†’ SET ì ˆì˜ ëŒ€ìƒ


ì´ëŸ° êµ¬ì¡°ë¼ë©´, ClickHouseì˜ UPDATE ì¿¼ë¦¬ë¥¼ ë™ì ìœ¼ë¡œ ìƒì„±í•´ì„œ ì²˜ë¦¬í•˜ë©´ ë©ë‹ˆë‹¤.


---

âœ… ì „ì²´ êµ¬ì¡° ìš”ì•½

def handle_update(row, client):
    table = row.get("table")
    before = row.get("before")
    after = row.get("after")

    if not before or not after:
        print("[WARN] U ì´ë²¤íŠ¸ì— before/afterê°€ ì—†ìŒ")
        return

    # 1. í…Œì´ë¸”ë³„ PK ì •ë³´ ë¡œë”©
    with open("primary_keys.json") as f:
        pk_map = json.load(f)

    primary_keys = pk_map.get(table)
    if not primary_keys:
        print(f"[ERROR] í…Œì´ë¸” {table}ì˜ PK ì •ë³´ ì—†ìŒ")
        return

    # 2. SET ì ˆ (afterì— ìˆëŠ” ì»¬ëŸ¼ë§Œ)
    set_clause = ", ".join(
        f"{col} = {format_value(val)}"
        for col, val in after.items()
    )

    if not set_clause:
        print("[INFO] ë³€ê²½ëœ ì»¬ëŸ¼ ì—†ìŒ (after ë¹„ì–´ ìˆìŒ)")
        return

    # 3. WHERE ì ˆ (beforeì— ìˆëŠ” PK ì»¬ëŸ¼ë§Œ)
    where_clause = " AND ".join(
        f"{col} = {format_value(before[col])}"
        for col in primary_keys
        if col in before
    )

    # 4. SQL ì‹¤í–‰
    sql = f"ALTER TABLE {table} UPDATE {set_clause} WHERE {where_clause}"
    client.execute(sql)


---

ğŸ”§ format_value í•¨ìˆ˜ (SQL ì•ˆì „í•˜ê²Œ í¬ë§·)

def format_value(val):
    if val is None:
        return 'NULL'
    if isinstance(val, str):
        return f"'{val.replace(\"'\", \"''\")}'"  # SQL injection ë°©ì§€ìš© ì´ìŠ¤ì¼€ì´í”„
    return str(val)


---

âœ… ì˜ˆì‹œ

Kafka ë©”ì‹œì§€ ì˜ˆì‹œ

{
  "table": "user",
  "op_code": "U",
  "before": { "id": 1001 },
  "after": { "name": "Alice", "age": 32 }
}

ClickHouse ì‹¤í–‰ë  SQL

ALTER TABLE user
UPDATE name = 'Alice', age = 32
WHERE id = 1001


---

ğŸ“Œ ë³´ì™„ ê³ ë ¤ì‚¬í•­

beforeì— PKê°€ ì—†ìœ¼ë©´ UPDATEëŠ” ë¶ˆê°€ëŠ¥ â†’ validation í•„ìš”

afterê°€ ë„ˆë¬´ ë§ê±°ë‚˜ ë¯¼ê° ë°ì´í„°ê°€ í¬í•¨ë˜ë©´ audit log ê³ ë ¤

ALTER TABLE ... UPDATEëŠ” ì¦‰ì‹œ ë°˜ì˜ì´ ì•„ë‹Œ background mergeë¡œ ì²˜ë¦¬ë¨



---

í•„ìš”í•˜ì‹œë©´:

DELETE + INSERT ë°©ì‹ìœ¼ë¡œë„ ë§Œë“¤ì–´ ë“œë¦´ ìˆ˜ ìˆê³ ,

Spark SQL ê¸°ë°˜ìœ¼ë¡œ ë¶„ì‚° ì²˜ë¦¬í•˜ëŠ” PySpark ì½”ë“œë„ í™•ì¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.


ì¶”ê°€ ìš”ì²­ ì£¼ì‹œë©´ ë§ì¶¤ ì½”ë“œ ë” ë“œë¦´ê²Œìš”.

