
íŒŒë¼ë¯¸í„°ë¡œ DAYSë¥¼ ë°›ëŠ” ë²„ì „ìœ¼ë¡œ ë°”ê¿”ì„œ ë³´ì—¬ì¤„ê²Œ.
(ì¸ì ì—†ìœ¼ë©´ ê¸°ë³¸ 90ì¼, ìˆ«ìë§Œ ë°›ë„ë¡ ê°„ë‹¨ ê²€ì¦ë„ ë„£ì—ˆì–´.)


---

ğŸ”§ ch_drop_old_partitions.sh (DAYS íŒŒë¼ë¯¸í„° ë²„ì „)

#!/bin/bash

########################################
# ì‚¬ìš©ë²•:
#   ./ch_drop_old_partitions.sh          # ê¸°ë³¸ 90ì¼ ì´ì „ íŒŒí‹°ì…˜ ì‚­ì œ
#   ./ch_drop_old_partitions.sh 120      # 120ì¼ ì´ì „ íŒŒí‹°ì…˜ ì‚­ì œ
########################################

# 1. DAYS íŒŒë¼ë¯¸í„° ì²˜ë¦¬ (ê¸°ë³¸ê°’ 90)
if [[ -z "$1" ]]; then
  DAYS=90
else
  # ìˆ«ìì¸ì§€ ê°„ë‹¨ ì²´í¬
  if ! [[ "$1" =~ ^[0-9]+$ ]]; then
    echo "Usage: $0 [DAYS]"
    echo "  DAYSëŠ” ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤. ì˜ˆ: $0 90"
    exit 1
  fi
  DAYS="$1"
fi

# 2. ClickHouse ì ‘ì† ì •ë³´
CH_HOST="localhost"
CH_PORT="9000"
CH_USER="default"
CH_PASS=""           # ë¹„ë°€ë²ˆí˜¸ ìˆìœ¼ë©´ ì…ë ¥
CH_OPTS="--host=${CH_HOST} --port=${CH_PORT} --user=${CH_USER} --password=${CH_PASS}"

# 3. ëŒ€ìƒ í…Œì´ë¸” ëª©ë¡ (db.table í˜•ì‹)
TABLES=(
  "your_db.table1"
  "your_db.table2"
  "your_db.table3"
)

# 4. ë¡œê·¸ íŒŒì¼
LOG_FILE="/var/log/ch_drop_daily_partitions.log"

echo "==================================================" >> "$LOG_FILE"
echo "$(date '+%Y-%m-%d %H:%M:%S') - START partition drop (DAYS=$DAYS)" >> "$LOG_FILE"

for T in "${TABLES[@]}"; do
  DB="${T%%.*}"
  TB="${T#*.}"

  echo "$(date '+%Y-%m-%d %H:%M:%S') - Checking $DB.$TB" >> "$LOG_FILE"

  # 5. DAYSì¼ ì´ì „ íŒŒí‹°ì…˜ì— ëŒ€í•œ DROP ì¿¼ë¦¬ ìƒì„±
  SQL_GENERATE="
    SELECT DISTINCT
      'ALTER TABLE ' || database || '.' || table || ' DROP PARTITION ' ||
      (CASE
        WHEN partition LIKE '%-%' THEN quote(partition)  -- '2025-11-01' ê°™ì€ ê²½ìš°
        ELSE partition                                   -- '20251101' ê°™ì€ ê²½ìš°
       END) || ';'
    FROM system.parts
    WHERE database = '${DB}'
      AND table = '${TB}'
      AND active
      AND toDate(min_time) < today() - INTERVAL ${DAYS} DAY
    ORDER BY partition;
  "

  # ìƒì„±ëœ DROP PARTITION ì¿¼ë¦¬ë“¤ ê°€ì ¸ì˜¤ê¸°
  CMDS=$(clickhouse-client $CH_OPTS --query="$SQL_GENERATE")

  if [[ -z "$CMDS" ]]; then
    echo "$(date '+%Y-%m-%d %H:%M:%S') - No old partitions for $DB.$TB" >> "$LOG_FILE"
    continue
  fi

  echo "$(date '+%Y-%m-%d %H:%M:%S') - Will execute:" >> "$LOG_FILE"
  echo "$CMDS" >> "$LOG_FILE"

  # ì‹¤ì œ íŒŒí‹°ì…˜ ë“œë ì‹¤í–‰
  echo "$CMDS" | clickhouse-client $CH_OPTS >> "$LOG_FILE" 2>&1

done

echo "$(date '+%Y-%m-%d %H:%M:%S') - END partition drop" >> "$LOG_FILE"
echo "==================================================" >> "$LOG_FILE"


---

âœ… ì‚¬ìš© ì˜ˆì‹œ

chmod +x ch_drop_old_partitions.sh

# ê¸°ë³¸ 90ì¼ ì´ì „ íŒŒí‹°ì…˜ ì‚­ì œ
./ch_drop_old_partitions.sh

# 120ì¼ ì´ì „ íŒŒí‹°ì…˜ ì‚­ì œ
./ch_drop_old_partitions.sh 120

í¬ë¡ ì— ë„£ì„ ë•Œë„ ì´ë ‡ê²Œ ì¡°ì • ê°€ëŠ¥í•´ìš”:

# ë§¤ì¼ ìƒˆë²½ 4ì‹œ, 90ì¼ ì´ì „ ì‚­ì œ
0 4 * * * /app/scripts/ch_drop_old_partitions.sh 90 >> /var/log/ch_drop_daily_partitions.cron.log 2>&1

ì›í•˜ë©´ TABLES ë°°ì—´ì„ system.tablesì—ì„œ íŒ¨í„´ìœ¼ë¡œ ìë™ ì¡°íšŒí•˜ëŠ” ë²„ì „(ì˜ˆ: ai_log_%ë§Œ)ë„ ë§Œë“¤ì–´ ì¤„ê²Œ.
