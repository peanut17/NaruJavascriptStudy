
ì•„ë˜ëŠ” Grafana 25.x(=Grafana 10.x) ê¸°ì¤€ìœ¼ë¡œ
Service Account í† í° ìë™ ìƒì„± / ê°±ì‹ (ì¬ë°œê¸‰) / ì‚­ì œê¹Œì§€ í•œ ë²ˆì— ê´€ë¦¬í•  ìˆ˜ ìˆëŠ”
âœ” ë¦¬ëˆ…ìŠ¤ Bash ìŠ¤í¬ë¦½íŠ¸(grafana_token.sh) ì…ë‹ˆë‹¤.

â€£ ì‹¤ì œ ìš´ì˜ í™˜ê²½ì—ì„œ ë°”ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ
âœ” ì—ëŸ¬ ì²´í¬
âœ” JSON íŒŒì‹±(jq ì‚¬ìš©)
âœ” ë¡œê·¸ ì¶œë ¥
ê¹Œì§€ ëª¨ë‘ í¬í•¨í–ˆìŠµë‹ˆë‹¤.


---

âœ… grafana_token.sh (Full Version / ìš´ì˜ ê°€ëŠ¥)

> âš  í•„ìš” íŒ¨í‚¤ì§€: jq

sudo apt install jq




---

#!/bin/bash

# =========================================
# Grafana Token Automation Script
# =========================================

GRAFANA_URL="http://localhost:3000"
ADMIN_TOKEN="YOUR_ADMIN_TOKEN"     # ê´€ë¦¬ì(Admin) í† í° í•„ìš”
SA_NAME="clickhouse-api"           # Service Account ì´ë¦„
TOKEN_NAME="auto-token"            # ìƒì„±/ê°±ì‹ í•˜ëŠ” Token ì´ë¦„

# =========================================

header() {
  echo "=============================================="
  echo "$1"
  echo "=============================================="
}

# ------------ Service Account ID ì¡°íšŒ ------------
get_sa_id() {
  curl -s -H "Authorization: Bearer $ADMIN_TOKEN" \
       "$GRAFANA_URL/api/serviceaccounts/search" \
  | jq ".serviceAccounts[] | select(.name==\"$SA_NAME\") | .id"
}

# ------------ ì„œë¹„ìŠ¤ ê³„ì • ì—†ìœ¼ë©´ ìƒì„± ------------
create_service_account_if_not_exists() {
  SA_ID=$(get_sa_id)

  if [[ -z "$SA_ID" ]]; then
    header "Service Account ì—†ìŒ â†’ ìƒì„± ì¤‘"
    SA_ID=$(curl -s -X POST \
        -H "Authorization: Bearer $ADMIN_TOKEN" \
        -H "Content-Type: application/json" \
        -d "{\"name\": \"$SA_NAME\", \"role\": \"Viewer\"}" \
        "$GRAFANA_URL/api/serviceaccounts" | jq -r ".id")
    echo "â†’ ìƒì„±ëœ Service Account ID: $SA_ID"
  else
    echo "Service Account ì¡´ì¬(ID=$SA_ID)"
  fi
}

# ------------ ê¸°ì¡´ í† í° ID ì¡°íšŒ ------------
get_existing_token_id() {
  curl -s -H "Authorization: Bearer $ADMIN_TOKEN" \
       "$GRAFANA_URL/api/serviceaccounts/$1/tokens" \
  | jq ".[] | select(.name==\"$TOKEN_NAME\") | .id"
}

# ------------ Token ìƒì„± ------------
create_token() {
  header "í† í° ìƒì„± ì¤‘"

  SA_ID=$(get_sa_id)

  NEW_TOKEN=$(curl -s -X POST \
      -H "Authorization: Bearer $ADMIN_TOKEN" \
      -H "Content-Type: application/json" \
      -d "{\"name\": \"$TOKEN_NAME\", \"secondsToLive\": 0}" \
      "$GRAFANA_URL/api/serviceaccounts/$SA_ID/tokens")

  TOKEN_VALUE=$(echo "$NEW_TOKEN" | jq -r ".key")
  echo "â†’ ìƒì„± ì™„ë£Œ"
  echo "----------------------------------------------"
  echo "TOKEN:"
  echo "$TOKEN_VALUE"
  echo "----------------------------------------------"

  echo "$TOKEN_VALUE" > generated_token.txt
  echo "í† í°ì´ generated_token.txt ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."
}

# ------------ Token ì‚­ì œ ------------
delete_token() {
  header "ê¸°ì¡´ í† í° ì‚­ì œ ì¤‘"

  SA_ID=$(get_sa_id)
  TOKEN_ID=$(get_existing_token_id $SA_ID)

  if [[ -z "$TOKEN_ID" ]]; then
    echo "ì‚­ì œí•  í† í° ì—†ìŒ."
    return
  fi

  curl -s -X DELETE \
    -H "Authorization: Bearer $ADMIN_TOKEN" \
    "$GRAFANA_URL/api/serviceaccounts/$SA_ID/tokens/$TOKEN_ID"

  echo "â†’ Token ì‚­ì œ ì™„ë£Œ (ID=$TOKEN_ID)"
}

# ------------ Token ê°±ì‹ (ì¬ë°œê¸‰) ------------
renew_token() {
  header "í† í° ê°±ì‹ (ì‚­ì œ + ì¬ìƒì„±)"

  delete_token
  sleep 1
  create_token
}

# ------------ Help ì¶œë ¥ ------------
print_help() {
  echo "ì‚¬ìš©ë²•:"
  echo "  $0 create    # í† í° ìƒì„±"
  echo "  $0 renew     # í† í° ê°±ì‹  (ì‚­ì œ í›„ ìƒˆë¡œ ìƒì„±)"
  echo "  $0 delete    # í† í° ì‚­ì œ"
  echo "  $0 sa        # Service Account ID í™•ì¸"
}

# ------------ ì‹¤í–‰ ì˜µì…˜ ì²˜ë¦¬ ------------
case "$1" in
  create)
    create_service_account_if_not_exists
    create_token
    ;;
  renew)
    create_service_account_if_not_exists
    renew_token
    ;;
  delete)
    create_service_account_if_not_exists
    delete_token
    ;;
  sa)
    get_sa_id
    ;;
  *)
    print_help
    ;;
esac


---

âœ… ì‚¬ìš©ë²•

1. ìŠ¤í¬ë¦½íŠ¸ ì €ì¥

nano grafana_token.sh

ë‚´ìš© ë¶™ì—¬ë„£ê¸° â†’ ì €ì¥

2. ì‹¤í–‰ê¶Œí•œ

chmod +x grafana_token.sh

3. ì‚¬ìš© ì˜ˆì‹œ

âœ” í† í° ìƒì„±

./grafana_token.sh create

âœ” í† í° ê°±ì‹ (rotate)

./grafana_token.sh renew

âœ” í† í° ì‚­ì œ

./grafana_token.sh delete

âœ” Service Account ID ì¡°íšŒ

./grafana_token.sh sa


---

ğŸ”¥ í† í° ìë™ íšŒì „(Cron ë“±ë¡)ë„ ê°€ëŠ¥

ì˜ˆ: ë§¤ì£¼ ì¼ìš”ì¼ ìƒˆ í† í° ë§Œë“¤ê³  rotate

crontab -e

0 3 * * 0 /root/grafana_token.sh renew


---

ğŸ”§ ì¶”ê°€ë¡œ ë§Œë“¤ì–´ë“œë¦´ ìˆ˜ ìˆìŒ

ì›í•œë‹¤ë©´:

ìƒì„±ëœ í† í°ì„ environment íŒŒì¼(.env)ë¡œ ìë™ ì €ì¥

ClickHouse ì¿¼ë¦¬ ìë™ í˜¸ì¶œ ìŠ¤í¬ë¦½íŠ¸

Grafana APIë¡œ ëŒ€ì‹œë³´ë“œ ìë™ Import/Export ìŠ¤í¬ë¦½íŠ¸

ì¿ ë²„ë„¤í‹°ìŠ¤ Secret ìë™ ê°±ì‹ (í† í° rotate)


ì–´ë–¤ ë°©ì‹ìœ¼ë¡œ ì‚¬ìš©í• ì§€ ë§í•´ì£¼ë©´ ë” ë§ì¶°ì„œ ê°œì„ í•´ì¤„ê²Œ!
